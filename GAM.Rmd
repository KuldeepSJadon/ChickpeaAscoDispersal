---
title: "Fit GAMs to dispersal patterns of _Ascochyta_ conidia"
author: "A.H. Sparks"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 12, fig.height = 9) 
```

## Import Data

```{r libraries, message=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, broom, skimr, devtools, ggpubr, mgcv, extrafont, mgcViz, here)

theme_set(theme_pubclean(base_size = 14))

# load the function to print GAM figures
source(here("R", "p_gam.R"))
```

```{r import_data, message=FALSE}
# import
lesion <- read_csv(here("cache", "summarised_lesion_data.csv"))
weather <- read_csv(here("cache", "weather_summary.csv"))

dat <- left_join(lesion, weather, by = c("site" = "Location", "rep" = "Rep"))
```

```{r fonts, include=FALSE, message=FALSE, eval=FALSE}
# run only if knitting on new computer
# this is necessary to embed fonts in .eps files for EJPP
font_import(pattern = "Arial")
loadfonts(device = "postscript") 
```

## Fit GAMs

For reproducibility purposes, use `set.seed()`.

```{r set-seed, echo=TRUE}
set.seed(27)
```

### mod1 - s(Distance)

```{r fit-mod1}
mod1 <-
   gam(
      mean_pot_count ~ s(distance, k = 5),
      data = dat
   )

summary(mod1)

print(p_gam(x = getViz(mod1)) +
         ggtitle("s(Distance)"),
      pages = 1)
```

### mod2 - s(Distance) + Precipitation

```{r fit-mod2}
mod2 <-
   gam(
      mean_pot_count ~ sum_rain+ s(distance, k = 5),
      data = dat
   )

summary(mod2)

print(p_gam(x = getViz(mod2)) +
         ggtitle("s(Distance) + Precipitation"),
      pages = 1)
```

### mod3 - s(Distance) + Windspeed
```{r fit-mod3}
mod3 <-
   gam(mean_pot_count ~ mws + s(distance, k = 5),
       data = dat)

summary(mod3)

print(p_gam(x = getViz(mod3)) +
         ggtitle("s(Distance) + Windspeed"),
      pages = 1)
```

### mod4 - s(Distance) + Windspeed + Precipitation
```{r fit-mod4}
mod4 <-
   gam(mean_pot_count ~ sum_rain + mws + s(distance, k = 5),
       data = dat)

summary(mod4)

print(p_gam(x = getViz(mod4)) +
         ggtitle("s(Distance) + Windspeed + Precipitation"),
      pages = 1)
```

### mod5 - s(Distance + Windspeed) + Precipitation

```{r fit-mod5}
mod5 <-
   gam(
      mean_pot_count ~ sum_rain + s(distance + mws, k = 5),
      data = dat
   )

summary(mod5)


print(p_gam(x = getViz(mod5)) +
         ggtitle("s(Distance + Windspeed) + Precipitation"),
      pages = 1)
```

### mod6 - s(Distance) + s(Windspeed) + Precipitation

```{r fit-mod6}
mod6 <-
   gam(
      mean_pot_count ~ sum_rain + s(distance, k = 5) + s(mws, k = 5),
      data = dat
   )

summary(mod6)


print(p_gam(x = getViz(mod6)) +
         ggtitle("s(Distance) + s(Windspeed) + Precipitation"),
      pages = 1)
```

### mod7 - s(Distance) + s(Windspeed)

```{r fit-mod7}
mod7 <-
   gam(
      mean_pot_count ~ s(distance, k = 5) + s(mws, k = 5),
      data = dat
   )

summary(mod7)

print(p_gam(x = getViz(mod7)) +
         ggtitle("s(Distance) + s(Windspeed)"),
      pages = 1)
```

### mod8 - s(Distance) + s(Windspeed) + s(Precipitation)

```{r fit-mod8}
mod8 <-
   gam(
      mean_pot_count ~ s(distance, k = 5) + s(mws, k = 5) + s(sum_rain, k = 5),
      data = dat
   )

summary(mod8)


print(p_gam(x = getViz(mod8)) +
         ggtitle("s(Distance) + s(Windspeed) + s(Precipitation)"),
      pages = 1)
```

### mod9 - s(Distance) + s(Precipitation)

```{r fit-mod9}
mod9 <-
   gam(
      mean_pot_count ~ s(distance, k = 5) + s(sum_rain, k = 5),
      data = dat
   )

summary(mod9)

print(p_gam(x = getViz(mod9)) +
         ggtitle("s(Distance) + s(Precipitation)"),
      pages = 1)
```

### mod10 - s(Distance) +s(Precipitation) + Windspeed

```{r fit-mod10}
mod10 <-
   gam(
      mean_pot_count ~ s(distance, k = 5) + s(sum_rain, k = 5) + mws,
      data = dat
   )

summary(mod10)

print(p_gam(x = getViz(mod10)) +
         ggtitle("s(Distance) + s(Precipitation) + Windspeed"),
      pages = 1)
```

### mod11.0 - s(Distance) + s(Windspeed) + s(Precipitation), family = tw()

This is the same as `mod8` but using `family = tw()`, see `?family.mgcv` for more on the families. The Tweedie distribution is used where the distribution has a positive mass at zero, but is continuous unlike the Poisson distribution that requires count data.
The data visualisation shows clearly that the mean pot count data have this shape.

```{r fit-mod11.0}
mod11.0 <-
   gam(
      mean_pot_count ~ s(distance, k = 5) + 
         s(mws, k = 5) + 
         s(sum_rain, k = 5),
      data = dat,
      family = tw()
   )

summary(mod11.0)

print(p_gam(x = getViz(mod11.0)) +
   ggtitle("s(Distance) + s(Windspeed) + s(Precipitation), family = tw()"),
   pages = 1)
```

### mod11.1 - s(Distance, bs = "ts") + s(Windspeed, bs = "ts") + s(Precipitation, bs = "ts"), family = tw()

```{r fit-mod11.1}
mod11.1 <-
   gam(
      mean_pot_count ~ s(distance, k = 5, bs = "ts") + 
         s(mws, k = 5, bs = "ts") + 
         s(sum_rain, k = 5, bs = "ts"),
      data = dat,
      family = tw()
   )

summary(mod11.1)

print(
   p_gam(x = getViz(mod11.1)) +
      ggtitle(
         "s(Distance, bs = 'ts') + s(Windspeed, bs = 'ts')\n+ s(Precipitation, bs = 'ts'), family = tw()"
      ),
   pages = 1
)
```

This model, same structure as `mod11.0`, uses thin-plate splines to shrink the coefficients of the smooth to zero.

## Compare the Models

### AIC, BIC
```{r compare-mods}
models <- list(mod1 = mod1,
               mod2 = mod2,
               mod3 = mod3,
               mod4 = mod4,
               mod5 = mod5,
               mod6 = mod6,
               mod7 = mod7,
               mod8 = mod8,
               mod9 = mod9,
               mod10 = mod10,
               mod11.0 = mod11.0,
               mod11.1 = mod11.1
               )
map_df(models, glance, .id = "model") %>%
   arrange(AIC)
```

### R^2^
```{r r2}
enframe(c(
   mod1 = summary(mod1)$r.sq,
   mod2 = summary(mod2)$r.sq,
   mod3 = summary(mod3)$r.sq,
   mod4 = summary(mod4)$r.sq,
   mod5 = summary(mod5)$r.sq,
   mod6 = summary(mod6)$r.sq,
   mod7 = summary(mod7)$r.sq,
   mod8 = summary(mod8)$r.sq,
   mod9 = summary(mod9)$r.sq,
   mod10 = summary(mod10)$r.sq,
   mod11.0 = summary(mod11.0)$r.sq,
   mod11.1 = summary(mod11.1)$r.sq
)) %>%
   arrange(desc(value))
```

### ANOVA
```{r anova}
anova(mod1,
      mod2,
      mod3,
      mod4,
      mod5,
      mod6,
      mod7,
      mod8,
      mod9,
      mod10,
      mod11.0,
      mod11.1,
      test = "F")
```

### Check Best Model Fit

#### Mod11.0 - s(Distance) + s(Windspeed) + s(Precipitation), family = tw()

```{r mod-check11.0}
mod11.0_vis <- getViz(mod11.0)
check(mod11.0_vis,
      a.qq = list(method = "tnorm", 
                  a.cipoly = list(fill = "light blue")), 
      a.respoi = list(size = 0.5), 
      a.hist = list(bins = 10))
```

#### Mod11.0 - s(Distance, family = "ts") + s(Windspeed, family = "ts") + s(Precipitation, family = "ts"), family = tw()

```{r mod_check11.1}
mod11.1_vis <- getViz(mod11.1)
check(mod11.1_vis,
      a.qq = list(method = "tnorm", 
                  a.cipoly = list(fill = "light blue")), 
      a.respoi = list(size = 0.5), 
      a.hist = list(bins = 10))
```

```{r save_gam_plot, include=FALSE}
# generate a new plot.gam object just for the publication (no main title)
p11.1 <- p_gam(x = getViz(mod11.0))

# save png and eps files
png(
   file = "figures/Fig1.png",
   width = 480,
   height = 480,
   units = "px",
   pointsize = 14
)
print(p11.1, pages = 1)
dev.off()

postscript(file = "figures/Fig1.eps", family = "Arial")
par(mar = c(5, 3, 2, 2) + 0.1)
print(p11.1, pages = 1)
dev.off()

embed_fonts("figures/Fig1.eps", outfile = "figures/Fig1.eps",
            options = "-dEPSCrop")
```

## Thoughts

This model, _mod11.0_, 
`mean_pot_count ~ s(Distance) + s(Windspeed) + s(Precipitation) - family = tw()`,
lacks enough numbers of basis functions for two of three predictors, `distance`,
`wsp`, but it's close. Realistically we need to increase the `k` values for
these predictors, but we're lacking the data to do this.
