---
title: "Fit GAMs to dispersal patterns of _Ascochyta_ conidia"
author: "A.H. Sparks"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(fig.width = 12, fig.height = 9) 
```

## Import Data

See "R/wrangle_raw_data.R" for the script that handles the data import. This
Rmd file focuses on the models themselves.

```{r libraries, message=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, broom, skimr, devtools, mgcv)
```

```{r import data, message=FALSE}
source("R/wrangle_raw_data.R")
```

## Fit GAMs

For reproducibility purposes, use `set.seed()`.

```{r set-seed, echo=TRUE}
set.seed(27)
```

### mod1 - s(Distance)

```{r fit-mod1}
mod1 <-
   gam(
      mean_count_pot ~ s(dist, k = 5),
      data = dat
   )

summary(mod1)
```

### mod2 - s(Distance) + Precipitation

```{r fit-mod2}
mod2 <-
   gam(
      mean_count_pot ~ sum_rain+ s(dist, k = 5),
      data = dat
   )

summary(mod2)
```

### mod3 - s(Distance) + Windspeed
```{r fit-mod3}
mod3 <-
   gam(mean_count_pot ~ mws + s(dist, k = 5),
       data = dat)

summary(mod3)
```

### mod4 - s(Distance) + Windspeed + Precipitation
```{r fit-mod4}
mod4 <-
   gam(mean_count_pot ~ sum_rain + mws + s(dist, k = 5),
       data = dat)

summary(mod4)
```

### mod5 - s(Distance + Windspeed) + Precipitation

```{r fit-mod5}
mod5 <-
   gam(
      mean_count_pot ~ sum_rain + s(dist + mws, k = 5),
      data = dat
   )

summary(mod5)
```

### mod6 - s(Distance) + s(Windspeed) + Precipitation

```{r fit-mod6}
mod6 <-
   gam(
      mean_count_pot ~ sum_rain + s(dist, k = 5) + s(mws, k = 5),
      data = dat
   )

summary(mod6)
```

### mod7 - s(Distance) + s(Windspeed)

```{r fit-mod7}
mod7 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + s(mws, k = 5),
      data = dat
   )

summary(mod7)
```

### mod8 - s(Distance) + s(Windspeed) + s(Precipitation)

```{r fit-mod8}
mod8 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + s(mws, k = 5) + s(sum_rain, k = 5),
      data = dat
   )

summary(mod8)
```

### mod9 - s(Distance) + s(Precipitation)

```{r fit-mod9}
mod9 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + s(sum_rain, k = 5),
      data = dat
   )

summary(mod9)
```

### mod10 - s(Distance) +s(Precipitation) + Windspeed

```{r fit-mod10}
mod10 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + s(sum_rain, k = 5) + mws,
      data = dat
   )

summary(mod10)
```

### mod11.0 - s(Distance) + s(Windspeed) + s(Precipitation), family = tw()

This is the same as `mod8` but using `family = tw()`, see `?family.mgcv` for
more on the families. The Tweedie distribution is used where the distribution
has a positive mass at zero, but is continuous unlike the Poisson distribution
that requires count data. The data visualisation shows clearly that the mean
pot count data have this shape.

```{r fit-mod11.0}
mod11.0 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + 
         s(mws, k = 5) + 
         s(sum_rain, k = 5),
      data = dat,
      family = tw()
   )

summary(mod11.0)
```

Try fitting the same model using a different shrinkage smoother, `ts` is thin-
plate splines.

### mod11.1 - s(Distance, bs = "ts") + s(Windspeed, bs = "ts") + s(Precipitation, bs = "ts"), family = tw()

```{r fit-mod11.1}
mod11.1 <-
   gam(
      mean_count_pot ~ s(dist, k = 5, bs = "ts") + 
         s(mws, k = 5, bs = "ts") + 
         s(sum_rain, k = 5, bs = "ts"),
      data = dat,
      family = tw()
   )

summary(mod11.1)
```

This model, same structure as `mod11.0`, uses thin-plate splines to shrink the coefficients of the smooth to zero.

### mod12 - s(Distance) + s(Precipitation) + Windspeed, family = tw()

Looking at `mod11.1`, `mws` is not significant as a smoothed term, and we'd
suspect it was linear anyway, so add it as a linear term only.

```{r fit-mod12}
mod12 <-
   gam(
      mean_count_pot ~ s(dist, k = 5) + s(sum_rain, k = 5) + mws,
      data = dat,
      family = tw()
   )

summary(mod12)
```

## Compare the Models

### AIC, BIC
```{r compare-mods}
models <- list(mod1 = mod1,
               mod2 = mod2,
               mod3 = mod3,
               mod4 = mod4,
               mod5 = mod5,
               mod6 = mod6,
               mod7 = mod7,
               mod8 = mod8,
               mod9 = mod9,
               mod10 = mod10,
               mod11.0 = mod11.0,
               mod11.1 = mod11.1,
               mod12 = mod12
               )
map_df(models, glance, .id = "model") %>%
   arrange(AIC)
```

### R^2^
```{r r2}
enframe(c(
   mod1 = summary(mod1)$r.sq,
   mod2 = summary(mod2)$r.sq,
   mod3 = summary(mod3)$r.sq,
   mod4 = summary(mod4)$r.sq,
   mod5 = summary(mod5)$r.sq,
   mod6 = summary(mod6)$r.sq,
   mod7 = summary(mod7)$r.sq,
   mod8 = summary(mod8)$r.sq,
   mod9 = summary(mod9)$r.sq,
   mod10 = summary(mod10)$r.sq,
   mod11.0 = summary(mod11.0)$r.sq,
   mod11.1 = summary(mod11.1)$r.sq,
   mod12 = summary(mod12)$r.sq
)) %>%
   arrange(desc(value))
```

### Coefficients

```{r coef}
cat("\nmod1\n")
coef(mod1)
cat("\nmod2\n")
coef(mod2)
cat("\nmod3\n")
coef(mod3)
cat("\nmod4\n")
coef(mod4)
cat("\nmod5\n")
coef(mod5)
cat("\nmod6\n")
coef(mod6)
cat("\nmod7\n")
coef(mod7)
cat("\nmod8\n")
coef(mod8)
cat("\nmod9\n")
coef(mod9)
cat("\nmod10\n")
coef(mod10)
cat("\nmod11.0\n")
coef(mod11.0)
cat("\nmod11.1\n")
coef(mod11.1)
cat("\nmod12\n")
coef(mod12)
```

### ANOVA
```{r anova}
anova(mod1,
      mod2,
      mod3,
      mod4,
      mod5,
      mod6,
      mod7,
      mod8,
      mod9,
      mod10,
      mod11.0,
      mod11.1,
      mod12,
      test = "F")
```

### Visualise the Models

```{r vis-mods}
par(mfrow = c(2, 2))
plot(mod1, main = "s(Distance)", pages = 1, rug = TRUE)
plot(mod2, main = "s(Distance) + Precipitation", pages = 1, rug = TRUE)
plot(mod3, main = "s(Distance) + Windspeed", pages = 1, rug = TRUE)
plot(mod4, main = "s(Distance) + Windspeed + Precipitation", pages = 1, rug = TRUE)
plot(mod5, main = "s(Distance + Windspeed) + Precipitation", pages = 1, rug = TRUE)
plot(mod6, main = "s(Distance) + s(Windspeed) + Precipitation", pages = 1, rug = TRUE)
plot(mod7, main = "s(Distance) + s(Windspeed)", pages = 1, rug = TRUE)
plot(mod8, main = "s(Distance) + s(Windspeed) + s(Precipitation)", pages = 1, rug = TRUE)
plot(mod9, main = "s(Distance) + s(Precipitation)", pages = 1, rug = TRUE)
plot(mod10, main = "s(Distance) + s(Precipitation) + Windspeed", pages = 1, rug = TRUE)
plot(mod11.0, main = "s(Distance) + s(Windspeed) + s(Precipitation), family = tw()", pages = 1, rug = TRUE)
plot(mod11.1, main = "s(Distance, bs = 'ts') + s(Windspeed, bs = 'ts')\n+ s(Precipitation, bs = 'ts'), family = tw()", pages = 1, rug = TRUE)
plot(mod12, main = "s(Distance) + s(Precipitation) + Windspeed, family = tw()", pages = 1, rug = TRUE)
```

### Check Best Model Fit

#### Mod11.0 - s(Distance) + s(Windspeed) + s(Precipitation), family = tw()

```{r mod-check11}
gam.check(mod11.0)
```

## Thoughts

This model, _mod11.0_, 
`mean_pot_count ~ s(Distance) + s(Windspeed) + s(Precipitation) - family = tw()`,
lacks enough numbers of basis functions for two of three predictors, `dist`,
`wsp`, but it's close. Realistically we need to increase the `k` values for
these predictors, but we're lacking the data to do this.
