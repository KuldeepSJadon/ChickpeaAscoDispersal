---
title: "Visualise Data"
author: "A.H. Sparks"
date: "`r Sys.Date()`"
output:
   rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{visualise_data}
  %\VignetteEngine{knitr::rmarkdown_notangle}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.width = 9.4, fig.height = 9.4)
```

```{r libraries, message=FALSE}
library("tidyverse")
library("lubridate")
library("skimr")
library("clifro")
library("viridis")
library("ggpubr")
library("skimr")
library("extrafont")
library("here")
library("ChickpeaAscoDispersal")

theme_set(theme_pubclean(base_size = 14))
```

```{r fonts, include=FALSE, message=FALSE, eval=FALSE}
# run only if knitting on new computer
# this is necessary to embed fonts in .eps files for EJPP
font_import(pattern = "Arial")
loadfonts(device = "postscript") 
```

## Visualise Counts per Pot

```{r lesion-count, fig.cap="Density plot of mean lesions counted per pot for all six events.", message=FALSE, warning=FALSE}
ggplot(lesion_counts, aes(x = mean_pot_count)) +
   geom_density() +
   xlab("Mean lesion count per pot")
```

## Visualise the Dispersal Data

```{r combined-dispersal, message=FALSE, warning=FALSE, fig.cap="Mean number of conidia dispersed (counted as lesions) per pot during each spread event. Where ‘n’ indicates mean number of lesions counted on trap plants per pot and is represented by point size. The mean count values are shown on the y-axis and distance dispersed is on the x-axis. Red points and line show median lesions counted per trap plant. Conidia travelled up to 75 m in each of the six irrigation and rainfall event."}
ggplot(lesion_counts, aes(x = distance,
                y = mean_pot_count)) +
   geom_count() +
   stat_summary(fun.y = "median",
                geom = "line",
                na.rm = TRUE) +
   stat_summary(
      fun.y = "median",
      colour = "red",
      size = 2,
      geom = "point"
   ) +
   scale_x_continuous(breaks = c(0, 10, 25, 50, 75)) +
   ylim(c(-0.5, 9)) +
   ylab("Mean lesion count values") +
   xlab("Distance (m)") +
   facet_wrap(. ~ SpEv, ncol = 3)
```

```{r save-fig2, include=TRUE, eval=FALSE}
# save a .png to refer to while writing and a .eps for publication submission
ggsave(here::here("man", "figures/Fig2.png"))
ggsave(here::here("man", "figures/Fig2.eps"))
embed_fonts(
   file = here::here("man",
                     "figures/Fig2.eps"),
   outfile = here::here("man",
                        "figures/Fig2.eps"),
   options = "-dEPSCrop"
)
```

## Visualise the Rainfall

```{r rain, message=FALSE, warning=FALSE, fig.cap=paste0("Ten-minute precipitation data for each of the six rainfall or irrigation events at two locations. Events are denoted by the location, 'Horsham' or 'Curyo'; and whether the site was irrigated, 'Irrg' or rainfed 'Rain' or 'Mixd' (both simultaneously); and event '1', '2' or '3.' Precipitation values, 11&nbsp;mm that were applied, are not shown, only rainfall data are presented.")}

dat <- left_join(lesion_counts, cleaned_weather, by = c("site", "rep"))

dat %>%
   group_by(SpEv) %>%
   mutate(Hour = floor_date(time, "1 hour")) %>%
   group_by(SpEv, Hour) %>%
   summarize(sum(rainfall)) %>%
   ggplot(aes(x = Hour, y = `sum(rainfall)`)) +
   geom_col() +
   scale_x_datetime(
      "Date (day-month)",
      date_breaks = "day",
      date_labels = "%d-%m",
      date_minor_breaks = "hour",
      guide = guide_axis(check.overlap = TRUE)
   ) +
   ylab("Precipitation (mm)") +
   facet_wrap(. ~ SpEv, ncol = 3, scales = "free_x")
```

## Visualise the Wind Speed and Direction

```{r wind, message=FALSE, warning=FALSE, fig.cap=paste0("Windroses for spread events showing ten-minute wind speed and direction at the two Horsham sites. Curyo wind speed and direction data are not shown due to a weather station calibration issue resulting in incorrect data for wind direction.")}
pw <-
   with(
      dat,
      windrose(
         wind_speed,
         wind_direction,
         SpEv,
         n_col = 3,
         legend_title = "Wind speed (m/s)"
      )
   )
pw +
   scale_fill_viridis_d(name = "Wind Speed (m/s)", direction = -1) +
   xlab("") +
   theme_pubclean()
```

When inspecting these data, we noted that the wind direction for Curyo was against the direction of spread along the transects, which lead to further investigation of the weather data.
That investigation is detailed in [this analysis](06_Validate_Curyo_weather.html).

## Heatmap of Lesions Along Transects

```{r polar_coord_transects, message = FALSE, warning=FALSE, fig.cap=paste0("Heatmap showing count of mean lesions per pot at each station along each of ten transects. Note that any stations where the mean count was zero for any event, the data are not shown for clarity. Events are denoted by the location, 'Horsham' or 'Curyo'; source of precipitation 'Irrg' (irrigation), 'Rain' (rainfall) or 'Mixd' (both simultaneously); and event '1', '2' or '3.'")}
heat_dat <-
   lesion_counts %>%
   group_by(SpEv, degrees) %>%
   mutate(summed_count_pot =
             case_when(distance == 0 ~ sum(mean_pot_count),
                       TRUE ~ mean_pot_count)) %>%
   filter(mean_pot_count > 0)

ggplot(data = heat_dat,
       aes(
          x = degrees,
          y = distance,
          colour = summed_count_pot,
          size = summed_count_pot
       )) +
   geom_count(data = subset(heat_dat, distance == 0)) +
   geom_count(data = subset(heat_dat, distance > 0)) +
   scale_colour_viridis_c(
      direction = -1,
      name = "n",
      guide = "legend",
      breaks = c(1, 5, 10, 15, 20)
   ) +
   coord_polar(theta = "x",
               start = 0,
               direction = 1) +
   scale_size(
      range = c(2, 8),
      name = "n",
      breaks = c(1, 5, 10, 15, 20)
   ) +
   scale_x_continuous(
      breaks = c(0, 90, 180, 270),
      expand = c(0, 0),
      limits = c(0, 360),
      labels = c("N", "E", "S", "W")
   ) +
   scale_y_continuous(breaks = c(0, 10, 20, 50, 75),
                      limits = c(0, 75)) +
   ylab("Distance (m)") +
   xlab("Transect") +
   facet_wrap(. ~ SpEv, ncol = 3)
```

```{r save-fig4, include=FALSE, eval=FALSE}
ggsave(here::here("man", "figures/Fig4.png"))
ggsave(here::here("man", "figures/Fig4.eps"))
embed_fonts(
   file = here::here("man",
                     "figures/Fig4.eps"),
   outfile = here::here("man",
                        "figures/Fig4.eps"),
   options = "-dEPSCrop"
)
```
