---
title: "06_Compare_Curyo_weather"
author: "P. Melloy"
date: "10/03/2020"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library("tidyverse")
library("lubridate")
library("skimr")
library("ggpubr")
library("kableExtra")
library("scales")
library("here")
library("ChickpeaAscoDispersal")
library("stationaRy")
library("bomrang")
theme_set(theme_pubclean(base_size = 14))
```


```{r import-event, message=FALSE}
events <-
   read_csv(here("inst/data", "Dispersal experiments dates.csv")) %>%
   mutate(`assessment date` = dmy(`assessment date`)) %>%
   mutate(exposed = interval(`time out`, `time removed`))

evT <- sort(c(events$`time out`,events$`time removed`))
ExIn <- evT[1] %--% evT[length(evT)]
```

I need the function for circular averaging but can't seem to install it? Adam?

```{r import-Curyo, message=FALSE, warning=FALSE}
Curyo_w <-
   read_csv(here(
      "inst/data",
      "Curyo SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
   )) %>%
   select(Time,
          'Wind Speed - average (km/h)',
          'Wind Direction - average (ยบ)',
          "Rainfall - (mm)") %>%
   mutate(time = dmy_hm(Time)) %>%
   mutate(Location = "Curyo") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed - average (km/h)`) %>%
   rename(wd = `Wind Direction - average (ยบ)`) %>%
   rename(rainfall = `Rainfall - (mm)`)

Curyo_w <- aggregate(Curyo_w[c("ws","wd")], 
                 list(time = cut(as.POSIXct(Curyo_w$time)-1, "hour")),
                 mean) %>%
   mutate(Location = "Curyo")%>%
   mutate(time = as.character(time)) %>%
   mutate(time = ymd_hms(time)) %>%
   select(Location, everything()) %>%
   filter(time %within% ExIn)

```


```{r import-Curyo2, message=FALSE, warning=FALSE}
Curyo2_w <-
   read_csv(here(
      "inst/data",
      "DataFarmer_Data_202031081949847.csv"
   ),skip = 1) %>%
   mutate(time = dmy_hm(`Reading Time`)) %>%
   mutate(Location = "Curyo_alt") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed`) %>%
   rename(wd = `Wind Direction`) %>%
   rename(rh = Humidity) %>%
   rename(temp = Temperature) %>%
   rename(rainfall = `Rainfall`)%>%
   mutate(wd = case_when(wd == "N" ~ 0,
                         wd == "NNE" ~ 22.5,
                         wd == "NE" ~ 45,
                         wd == "ENE" ~ 67.5,
                         wd == "E" ~ 90,
                         wd == "ESE" ~ 112.5,
                         wd == "SE" ~ 135,
                         wd == "SSE" ~ 157.5,
                         wd == "S" ~ 180,
                         wd == "SSW" ~ 202.5,
                         wd == "SW" ~ 225,
                         wd == "WSW" ~ 247.5,
                         wd == "W" ~ 270,
                         wd == "WNW" ~ 292.5,
                         wd == "NW" ~ 315,
                         wd == "NNW" ~ 337.5))

Curyo_alt <- aggregate(Curyo2_w[c("ws","wd")], 
                 list(time = cut(as.POSIXct(Curyo2_w$time)-1, "hour")),
                 mean) %>%
   mutate(time = as.character(time)) %>%
   mutate(Location = "Curyo_alt") %>%
   mutate(time = ymd_hms(time)) %>%
   select(Location, everything()) %>%
   filter(time %within% ExIn)

Curyo_alt
```





```{r get_cuyroData}
curyo_latlong <- c(-35.779312, 142.778332)

stat.dat <- get_station_metadata()%>%
   dplyr::filter(name %in% sweep_for_stations(curyo_latlong)$name[1:10]) %>%
   dplyr::filter(id != "949999-00284") # station does causes the import to fail


for(i in stat.dat$id){
   if(i == stat.dat$id[1]){
      weather.list <- list()
   }
   print(stat.dat$name[which(stat.dat$id == i)])
   
   weather.list[[i]] <-
      get_met_data(i, years = 2019)%>%
      filter(time %within% ExIn)%>%
      mutate(Location = stat.dat$name[which(stat.dat$id == i)])%>%
      select(Location, everything())

}


weather.vic <- bind_rows(weather.list, Curyo_w,Curyo_alt)


```

```{r skim-weather.vic}

skim(weather.vic)

```

