---
title: "06_Compare_Curyo_weather"
author: "P. Melloy"
date: "10/03/2020"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library("tidyverse")
library("lubridate")
library("skimr")
library("ggpubr")
library("kableExtra")
library("scales")
library("here")
library("ChickpeaAscoDispersal")
library("stationaRy")
library("bomrang")
library("clifro")
library("leaflet")
library("htmltools")
theme_set(theme_pubclean(base_size = 14))
```


```{r import-event, message=FALSE}
events <-
   read_csv(here("inst/data", "Dispersal experiments dates.csv")) %>%
   mutate(`assessment date` = dmy(`assessment date`)) %>%
   mutate(exposed = interval(`time out`, `time removed`))
```


The experimental site Curyo is located approximatley 120 km north-east of Horsham Grains Innovation park (Department of Primary Industries Victoria). Trap plants were placed on transects on vectors rangeing from XX to YY in a north-north-west direction from the ascochyta infested chickpea stubble.
A single rainfall event at the Curyo site to trigger conidial dispersal between `r events[events$site == "Curyo",]$'time out'` and `r events[events$site == "Curyo",]$'time removed'`. However the onsite weather station adjacent to the trial recorded the wind direction as coming from the north, blowing towards the south.  

Conida were recorded travelling up to 75 meters from the infested stubble north, against the wind during the spread event. The collaborating researcher at VDPI confirmed this weather station did not have wind direction calibrated recently.  

This vignette is aimed at comparing the wind direction and wind speed to nearby weather stations.  

First we will import the weather data from the Curyo which we suspect to have inaccurate wind direction. The data will be formatted and filtered to only contain weather data during when the trap plants were exposed in the field.   

```{r import-Curyo, message=FALSE, warning=FALSE}
Curyo_w <-
   read_csv(here(
      "inst/data",
      "Curyo SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
   )) %>%
   select(Time,
          'Wind Speed - average (km/h)',
          'Wind Direction - average (ยบ)',
          "Rainfall - (mm)") %>%
   mutate(time = dmy_hm(Time)) %>%
   mutate(Location = "Curyo") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed - average (km/h)`) %>%
   rename(wd = `Wind Direction - average (ยบ)`) %>%
   rename(rainfall = `Rainfall - (mm)`) %>% 
   filter(time %within% events[6, "exposed"])
```


The data we download from Bueru of Meterology is in one hour increments, so we will aggregate the 10 minute data to one hourly.  
```{r aggregate_to_1_hour}
Curyo_w <- aggregate(Curyo_w[c("ws", "wd")],
                     list(time = cut(as.POSIXct(Curyo_w$time) - 1, "hour")),
                     circular.averaging) %>%
   mutate(Location = "Curyo") %>%
   mutate(time = as.character(time)) %>%
   mutate(time = ymd_hms(time)) %>%
   select(Location, everything())
```

Next we will import data from a second weather station at the Curyo field site approximately 10 km from where our trial took place.  
```{r import-Curyo2, message=FALSE, warning=FALSE}
Curyo2_w <-
   read_csv(here("inst/data",
                 "DataFarmer_Data_202031081949847.csv"),
            skip = 1) %>%
   mutate(time = dmy_hm(`Reading Time`)) %>%
   mutate(Location = "Curyo_alt") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed`) %>%
   rename(wd = `Wind Direction`) %>%
   rename(rh = Humidity) %>%
   rename(temp = Temperature) %>%
   rename(rainfall = `Rainfall`) %>%
   mutate(
      wd = case_when(
         wd == "N" ~ 0,
         wd == "NNE" ~ 22.5,
         wd == "NE" ~ 45,
         wd == "ENE" ~ 67.5,
         wd == "E" ~ 90,
         wd == "ESE" ~ 112.5,
         wd == "SE" ~ 135,
         wd == "SSE" ~ 157.5,
         wd == "S" ~ 180,
         wd == "SSW" ~ 202.5,
         wd == "SW" ~ 225,
         wd == "WSW" ~ 247.5,
         wd == "W" ~ 270,
         wd == "WNW" ~ 292.5,
         wd == "NW" ~ 315,
         wd == "NNW" ~ 337.5
      )
   )
```

The alternate Curyo weather station data also need to be aggregated into one hour increments.  

```{r Curyo_alt_aggregate}
Curyo_alt <- aggregate(Curyo2_w[c("ws", "wd")],
                       list(time = cut(as.POSIXct(Curyo2_w$time) - 1, "hour")),
                       circular.averaging) %>%
   mutate(time = as.character(time)) %>%
   mutate(Location = "Curyo_alt") %>%
   mutate(time = ymd_hms(time)) %>%
   select(Location, everything()) %>% 
   filter(time %within% events[6, "exposed"])

skim(Curyo_alt)
```

We have data from two weather stations in the field, however lets import data from BOM meterological stations nearby. We can use the `bomrang` function `sweep_for_stations()` to find the closest stations to our experimental site. Because `bomrang` only obtains historical daily weather information we need to use another package (`stationaRy`) which can retrieve hourly or 10 minute increment weather data from the same BOM stations. We then use the station name of the BOM stations in the `get_station_metadata` from the `stationaRy` package to obtain weather station ids. We need the ids to inform the function `get_met_data` from which stations we want weather data.  

The `get_met_data` function needs to be fun through a loop for each station. We place the weather data from each station into a tibble and store it as an element in a list.  

```{r get_cuyroData, message=FALSE}
curyo_latlong <- c(-35.779312, 142.778332)

stat.dat <- get_station_metadata() %>%
   filter(name %in% sweep_for_stations(curyo_latlong)$name[1:4])

for (i in stat.dat$id) {
   if (i == stat.dat$id[1]) {
      weather.list <- list()
   }
   print(stat.dat$name[which(stat.dat$id == i)])
   
   weather.list[[i]] <-
      get_met_data(i, years = 2019) %>%
      filter(time %within% events[6, "exposed"]) %>% 
      mutate(Location = stat.dat$name[which(stat.dat$id == i)]) %>%
      select(Location, everything())
}
```


Next we bind the data all together in a single tibble called `weather.vic`.  
```{r bind_met_data}
weather.vic <- bind_rows(weather.list, Curyo_w, Curyo_alt)
```

## Windroses

```{r skim-weather.vic}
skim(weather.vic)
```

We can visualise the windspeed and direction for each site using windrose.  
```{r windrose, message=FALSE}
pw <-
   with(
      weather.vic,
      windrose(
         ws,
         wd,
         Location,
         n_col = 4,
         legend_title = "Wind speed (m/s)"
      )
   )
pw +
   scale_fill_viridis_d(name = "Wind Speed (m/s)", direction = -1) +
   xlab("") +
   theme_pubclean()
```

## Wind speed correlations

Visually inspect the windspeed data comparing the Curyo site with the Birchip Cropping Group data from 10 kilometers away.

```{r ws-correlations}
ggplot(weather.vic, aes(x = time, y = ws)) +
   geom_point(aes(shape = Location,
                  colour = Location),
              size = 3.5) +
   scale_colour_viridis_d()
```

They do seem correlated but not an exact x-y relationship. Local gusts are possible?

## Weather station locations
Note the coordinates for the alternate Curyo station are not included.
```{r weather_station_map }
sweep_for_stations(curyo_latlong)[1:4]%>%
   select(name,lat,lon)%>%
   bind_rows(tibble(name = "CURYO",
                    lat = curyo_latlong[1],
                    lon = curyo_latlong[2]))%>%
   leaflet()%>%
   addTiles() %>%
   setView(lat = -36,
           lng = 142.7,
           zoom = 9) %>%
   addMarkers(
      lng = ~ lon,
      lat = ~ lat,
      popup = ~ htmlEscape(name)
   )
```

