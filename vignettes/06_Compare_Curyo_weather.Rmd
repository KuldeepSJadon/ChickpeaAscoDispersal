---
title: "Compare Curyo weather"
author: "P. Melloy"
date: "10/03/2020"
output: html_document
---

```{r libraries, message=FALSE, warning=FALSE}
library("tidyverse")
library("extrafont")
library("lubridate")
library("skimr")
library("ggpubr")
library("kableExtra")
library("scales")
library("here")
library("ChickpeaAscoDispersal")
library("stationaRy")
library("bomrang")
library("clifro")
library("leaflet")
library("htmltools")
theme_set(theme_pubclean(base_size = 14))
```

```{r fonts, include=FALSE, message=FALSE, eval=FALSE}
# run only if knitting on new computer/new R installation
# !!!! Run this in a regular interactive console not this markdown file !!!!
# this is necessary to embed fonts in .eps files for EJPP
font_import(pattern = "Arial")

# load the fonts necessary to embed in eps files
loadfonts(device = "postscript") 
```

```{r import-event, message=FALSE}
events <-
   read_csv(here("inst/data", "Dispersal experiments dates.csv")) %>%
   mutate(`assessment date` = dmy(`assessment date`)) %>%
   mutate(exposed = interval(`time out`, `time removed`))
```

## Background

The experimental site Curyo is located approximately 120 km north-east of Horsham Grains Innovation park (Department of Primary Industries Victoria).
Trap plants were placed on transects on vectors from 290˚ to 20˚ in a north-north-west direction from the ascochyta infected chickpea crop.
A single rainfall event at the Curyo site to trigger conidial dispersal between `r events[events$site == "Curyo",]$'time out'` and `r events[events$site == "Curyo",]$'time removed'`.
However the onsite weather station recorded the wind direction as coming from the north, blowing towards the south.  

Conida were recorded travelling up to 75&nbsp;meters from the infested stubble north, against the wind during the spread event.
The collaborating researcher at VDPI confirmed this weather station did not have wind direction calibrated recently.  

This vignette is aimed at comparing the wind direction and wind speed to nearby weather stations.  

## Data import

First we will import the weather data from the Curyo which we suspect to have inaccurate wind direction.
The data will be formatted and filtered to only contain weather data during when the trap plants were exposed in the field.   

```{r import-Curyo, message=FALSE, warning=FALSE}
Curyo_w <-
   read_csv(here(
      "inst/data",
      "Curyo SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
   )) %>%
   select(Time,
          'Wind Speed - average (km/h)',
          'Wind Direction - average (º)',
          "Rainfall - (mm)") %>%
   mutate(time = dmy_hm(Time)) %>%
   mutate(Location = "Curyo") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed - average (km/h)`) %>%
   rename(wd = `Wind Direction - average (º)`) %>%
   rename(rainfall = `Rainfall - (mm)`) %>% 
   filter(time %within% events[6, "exposed"])
```

The data we download from Bureau of Meteorology (BOM) is in one hour increments, so we will aggregate the 10 minute data to one hourly.  

```{r aggregate_to_1_hour}
Curyo_w <-
   Curyo_w %>%
   mutate(Day = day(time)) %>%
   mutate(Hour = hour(time)) %>%
   group_by(Hour, Day) %>%
   summarise(ws = mean(ws),
             wd = circular.averaging(wd)) %>%
   mutate(Location = "Curyo") %>%
   arrange(Day, Hour) %>%
   ungroup() %>%
   mutate(time = seq(
      from = events[events$site == "Curyo", ]$`time out`,
      to = events[events$site == "Curyo", ]$`time removed`,
      by = "hour"
   )) %>%
   select(Location, time, everything())
```

Next we will import data from a second weather station at the Curyo field site approximately 10&nbsp;kilometres from where our trial took place.

```{r import-Curyo2, message=FALSE, warning=FALSE}
BCG <-
   read_csv(here("inst/data",
                 "DataFarmer_Data_202031081949847.csv"),
            skip = 1) %>%
   mutate(time = dmy_hm(`Reading Time`)) %>%
   mutate(Location = "BCG") %>%
   select(Location, everything()) %>%
   rename(ws = `Wind Speed`) %>%
   rename(wd = `Wind Direction`) %>%
   rename(rh = Humidity) %>%
   rename(temp = Temperature) %>%
   rename(rainfall = `Rainfall`) %>%
   mutate(
      wd = case_when(
         wd == "N" ~ 0,
         wd == "NNE" ~ 22.5,
         wd == "NE" ~ 45,
         wd == "ENE" ~ 67.5,
         wd == "E" ~ 90,
         wd == "ESE" ~ 112.5,
         wd == "SE" ~ 135,
         wd == "SSE" ~ 157.5,
         wd == "S" ~ 180,
         wd == "SSW" ~ 202.5,
         wd == "SW" ~ 225,
         wd == "WSW" ~ 247.5,
         wd == "W" ~ 270,
         wd == "WNW" ~ 292.5,
         wd == "NW" ~ 315,
         wd == "NNW" ~ 337.5
      )
   ) %>%
   filter(time %within% events[6, "exposed"])
```

The alternate Curyo weather station data also need to be aggregated into one hour increments.

```{r Curyo_alt_aggregate}
Curyo_alt <-
   BCG %>%
   mutate(Day = day(time)) %>%
   mutate(Hour = hour(time)) %>%
   group_by(Hour, Day) %>%
   summarise(ws = mean(ws),
             wd = circular.averaging(wd)) %>%
   mutate(Location = "BCG*") %>%
   arrange(Day, Hour) %>%
   ungroup() %>%
   mutate(time = seq(
      from = events[events$site == "Curyo", ]$`time out`,
      to = events[events$site == "Curyo", ]$`time removed`,
      by = "hour"
   )[1:58]) %>%
   select(Location, time, everything())


skim(Curyo_alt)
```

We have data from two weather stations in the field, however lets import data from BOM meteorological stations nearby.
We can use the bomrang function `sweep_for_stations()` to find the closest stations to our experimental site.
Because bomrang only obtains historical daily weather information we need to use another package, stationaRy, which can retrieve hourly or 10 minute weather data from the same BOM stations.
We then use the station name of the BOM stations in the `get_station_metadata()` from the [stationaRy](https://cran.r-project.org/package=stationaRy) package to obtain weather station IDs.
We need the ids to inform the function `get_met_data()` from which stations we want weather data.  

The `get_met_data()` function needs to be fun through a loop for each station.
We place the weather data from each station into a `tibble` and store it as an element in a list.  

```{r get_cuyroData, message=FALSE}
curyo_latlong <- c(-35.779312, 142.778332)

stat.dat <- get_station_metadata() %>%
   filter(name %in% sweep_for_stations(curyo_latlong)$name[1:4])

for (i in stat.dat$id) {
   if (i == stat.dat$id[1]) {
      weather.list <- list()
   }
   print(stat.dat$name[which(stat.dat$id == i)])
   
   weather.list[[i]] <-
      get_met_data(i, years = 2019) %>%
      filter(time %within% events[6, "exposed"]) %>% 
      mutate(Location = stat.dat$name[which(stat.dat$id == i)]) %>%
      select(Location, everything())
}
```

Next we bind the data all together in a single tibble called `weather.vic`.  

```{r bind_met_data}
weather.vic <- bind_rows(weather.list, Curyo_w, Curyo_alt)

skim(weather.vic)
```

## Weather station locations

Note the coordinates for the alternate Curyo station, Birchip Group's, are not included.

```{r weather_station_map, message=FALSE}
# only take rows 1 and 4. Rows 2, 3 have no data and are not represented in windroses above
sweep_for_stations(curyo_latlong)[c(1, 4)] %>% 
   select(name, lat, lon) %>%
   bind_rows(tibble(name = "CURYO",
                    lat = curyo_latlong[1],
                    lon = curyo_latlong[2])) %>%
   leaflet() %>%
   addTiles() %>%
   setView(lat = -36,
           lng = 142.7,
           zoom = 9) %>%
   addMarkers(lng = ~ lon,
              lat = ~ lat,
              popup = ~ htmlEscape(name)) %>% 
   addScaleBar()
```

## Windroses

We can visualise the wind speed and direction for each site using windrose.  

```{r windrose, message=FALSE, fig.cap="Windroses for four weather stations at or near the Curyo site. The windstation on-site is labeled as 'Curyo', the Birchip Cropping Group station which was roughly 10&nbsp;km away is labelled with 'BCG', the remaining two stations are labelled with their respective BOM names, 'CHARLETON' and 'HOPETOUN AIRPORT'."}
pw <-
   with(
      weather.vic,
      windrose(
         ws,
         wd,
         Location,
         n_col = 4,
         legend_title = "Wind speed (m/s)"
      )
   )
pw +
   scale_fill_viridis_d(name = "Wind Speed (m/s)", direction = -1) +
   xlab("") +
   theme_pubclean()
```

From the windroses, it is apparent that the Curyo weather station is an outlier for direction and possibly windspeed.

## Wind speed correlations

Visually inspect the wind speed data comparing the Curyo site with the Birchip Cropping Group data from 10 kilometres away.

```{r ws-correlations, message=FALSE, warning=FALSE}
ggplot(weather.vic, aes(x = time, y = ws)) +
   geom_point(aes(shape = Location,
                  colour = Location),
              size = 3.5) +
   scale_colour_viridis_d()
```

They do seem correlated but it is not an exact x-y relationship and the Curyo gusts are higher than others, but that seems reasonable.

## Create new figure 3 excluding the Curyo data

Because of the incorrect wind direction data from the Curyo station, a new figure needs to be constructed with the BCG data. This will have wind directions that are more in-line with the actual event, but the speeds are not correct for Curyo.

```{r new-fig3}
# add the SpEv col to the BCG data
   
BCG <- 
   BCG %>% 
   mutate(rep = 1) %>% 
   unite(SpEv, c("Location", "rep"), remove = FALSE) %>% 
   select(SpEv, everything())

weather <- read_csv(here("inst/cache", "cleaned_weather.csv")) %>%
   rename(ws = wind_speed,
          wd = wind_direction) %>%
   filter(site != "Curyo") %>% 
   unite(SpEv, (c("site", "rep"))) %>% 
   select(SpEv,everything())

w <- bind_rows(weather[, c("SpEv", "time", "ws", "wd")],
               BCG[, c("SpEv", "time", "ws", "wd")])

pw <-
   with(
      w,
      windrose(
         ws,
         wd,
         SpEv,
         n_col = 3,
         legend_title = "Wind speed (m/s)"
      )
   )
pw +
   scale_fill_viridis_d(name = "Wind Speed (m/s)", direction = -1) +
   xlab("") +
   theme_pubclean()

```

```{r save-fig3, include=FALSE}
# save a .png to refer to while writing and a .eps for publication submission
ggsave(here("man", "figures/Fig3.png"))
ggsave(here("man", "figures/Fig3.eps"))
embed_fonts(
   here("man",
        "figures/Fig3.eps"),
   outfile = here("man",
                  "figures/Fig3.eps",
                  options = "-dEPSCrop")
)
```

