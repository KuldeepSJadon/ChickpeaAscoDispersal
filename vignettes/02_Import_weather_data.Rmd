---
title: "Weather Data Import and Cleaning"
author: "A.H. Sparks and P. Melloy"
date: "`r Sys.Date()`"
output:
   rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{02_weather_data_import}
  %\VignetteEngine{knitr::rmarkdown_notangle}
  %\VignetteEncoding{UTF-8}
---

```{r libraries, message=FALSE, warning=FALSE}
library("tidyverse")
library("lubridate")
library("skimr")
library("ggpubr")
library("kableExtra")
library("scales")
library("here")

theme_set(theme_pubclean(base_size = 14))
```

Import and select only the weather data necessary for analysis from Curyo and Horsham weather stations.
The original data are located in the "data" directory.
Dates for events are recorded in the "data/Dispersal experiments dates.csv" file and are used to subset the weather data in this file.

In this step the data are imported and only the date and time, average windspeed and average wind direction are selected.

## Curyo weather

### Import Curyo weather

```{r import-Curyo, message=FALSE, warning=FALSE}
Curyo_w <-
   read_csv(here(
      "inst/data",
      "Curyo SPA 2019 - Curyo SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
   )) %>%
   select(Time,
          'Wind Speed - average (km/h)',
          'Wind Direction - average (ยบ)',
          "Rainfall - (mm)") %>%
   mutate(Time = dmy_hm(Time)) %>%
   mutate(Location = "Curyo") %>%
   select(Location, everything())
```

### Inspect the Curyo data

```{r skim-Curyo}
skim(Curyo_w)
```

## Horsham weather

### Import Horsham weather

```{r import-Horsham, message=FALSE, warning=FALSE}
Horsham_w <-
   read_csv(
      here(
         "inst/data",
         "Horsham SPA 2019 - Horsham SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
      )
   ) %>%
   select(Time,
          'Wind Speed - average (km/h)',
          'Wind Direction - average (ยบ)',
          "Rainfall - (mm)") %>%
   mutate(Time = dmy_hm(Time)) %>%
   mutate(Location = "Horsham") %>%
   select(Location, everything())
```

### Inspect Horsham data

```{r skim-Horsham}
skim(Horsham_w)
```

## Merge and filter the data for events

### Import the event data

Event data have dates and times when trap plants were deployed, retrieved and assessed for each event.

```{r import-event, message=FALSE}
events <-
   read_csv(here("inst/data", "Dispersal experiments dates.csv")) %>%
   mutate(`assessment date` = dmy(`assessment date`)) %>%
   mutate(exposed = interval(`time out`, `time removed`))

kable(events, format = "html", table.attr = 'class="table table-hover"')
```

### Filter and merge the locations' the data

Filter the data removing any dates that do not have "event" data necessary for analysis.
Because events overlap at Horsham, the dryland and irrigated sites are handled separately first, then combined.
To do this, first `filter()`, then use `case_when()` to match the dates and times with the `events` data frame and create new variables to indicate which replicate and location, which is used to determine an event in the data.

```{r filter}
Horsham_irrg <-
   Horsham_w %>%
   filter(Time %within% events[1, "exposed"] |
             Time %within% events[2, "exposed"] |
             Time %within% events[3, "exposed"]) %>%
   mutate(
      Location = case_when(
         Time %within% events[1, "exposed"] ~ events[[1, "site"]],
         Time %within% events[2, "exposed"] ~ events[[2, "site"]],
         Time %within% events[3, "exposed"] ~ events[[3, "site"]]
      )
   ) %>%
   mutate(
      Rep = case_when(
         Time %within% events[1, "exposed"] ~ events[[1, "rep"]],
         Time %within% events[2, "exposed"] ~ events[[2, "rep"]],
         Time %within% events[3, "exposed"] ~ events[[3, "rep"]]
      )
   ) %>%
   rename(site = Location, rep = Rep, time = Time) %>%
   select(site, rep, time, everything())

Horsham_rain <-
   Horsham_w %>%
   filter(Time %within% events[4, "exposed"] |
             Time %within% events[5, "exposed"]) %>%
   mutate(Location = case_when(Time %within% events[4, "exposed"] ~ events[[4, "site"]],
                               Time %within% events[5, "exposed"] ~ events[[5, "site"]])) %>%
   mutate(Rep = case_when(Time %within% events[4, "exposed"] ~ events[[4, "rep"]],
                          Time %within% events[5, "exposed"] ~ events[[5, "rep"]], )) %>%
   rename(site = Location, rep = Rep, time = Time) %>%
   select(site, rep, time, everything())

Curyo_rain <-
   Curyo_w %>%
   filter(Time %within% events[which(events$site == "Curyo"), "exposed"]) %>%
   mutate(Location = case_when(Time %within% events[which(events$site == "Curyo"),
                                                    "exposed"] ~ "Curyo")) %>%
   mutate(Rep = case_when(Time %within% events[which(events$site == "Curyo"), "exposed"] ~
                             events[[which(events$site == "Curyo"), "rep"]])) %>%
   rename(site = Location, rep = Rep, time = Time) %>%
   select(site, rep, time, everything())

weather <- bind_rows(Curyo_rain, Horsham_irrg, Horsham_rain)
```

### Rename columns and add other calculations

The `Wind Speed - average (km/h)` column is converted to metres per second and renamed `wind_speed`.
The standard deviation of the wind speed and wind direction are calculated for the data.
The columns are then reordered by `Location`, `Rep`, `Time` and the weather data.

```{r rename-and-sd}
weather <-
   weather %>%
   mutate(`Wind Speed - average (km/h)` = `Wind Speed - average (km/h)` /
             3.6) %>%
   rename(wind_speed = `Wind Speed - average (km/h)`) %>%
   rename(wind_direction = `Wind Direction - average (ยบ)`) %>%
   rename(rainfall = `Rainfall - (mm)`) %>%
   select(site, rep, time, everything()) %>% 
   arrange(site, rep, time)

glimpse(weather)
```

### Summarise weather data by event

The weather data are now ready for summarising for each event that occured.
The resulting columns are:

* mws - mean wind speed in meters per second

* ws_sd - standard deviation of the wind speed

* mwd - mean wind direction in degrees

* wd_sd - standard deviation of the wind direction in degrees

* sum_rain - total rainfall during the event

```{r summary-weather}
weather_summary <-
   weather %>%
   group_by(site, rep) %>%
   summarise(
      mws = mean(wind_speed),
      ws_sd = sd(wind_speed),
      mwd = circular.averaging(wind_direction),
      sum_rain = sum(rainfall)
   )

skim(weather_summary)
```

## Export weather to cache

Save the resulting weather data to /cache for further use.

```{r export-weather, message=FALSE}
write_csv(weather, here("inst/cache", "cleaned_weather.csv"))
write_csv(weather_summary, here("inst/cache", "weather_summary.csv"))
```
