---
title: "Weather Data Import and Cleaning"
author: "A.H. Sparks"
date: "`r Sys.Date()`"
output:
  html_document:
    number_sections: yes
    toc: yes
    code_folding: hide
---

```{r libraries, message=FALSE}
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse, lubridate, skimr, here, kableExtra)
```

Import and select only the weather data necessary for analysis from Curyo and Horsham weather stations.
The original data are located in the "data" directory.
Dates for events are recorded in the "data/Dispersal experiments dates.csv" file and are used to subset the weather data in this file.

In this step the data are imported and only the date and time, average windspeed and average wind direction are selected.

## Curyo weather

### Import Curyo weather

```{r import-Curyo, message=FALSE, warning=FALSE}
Curyo_w <-
   read_csv(here(
      "data",
      "Curyo SPA 2019 - Curyo SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
   )) %>%
   select(1, 6, 8, 11) %>%
   mutate(Time = dmy_hm(Time)) %>%
   mutate(Location = "Curyo") %>%
   select(Location, everything())
```

### Inspect the Curyo data

```{r skim-Curyo}
skim(Curyo_w)
```

## Horsham weather

### Import Horsham weather

```{r import-Horsham, message=FALSE, warning=FALSE}
Horsham_w <-
   read_csv(
      here(
         "data",
         "Horsham SPA 2019 - Horsham SPA 2019 - Buffer 0 - 01-01-2019 to 06-12-2019.csv"
      )
   ) %>% 
   select(1, 6, 8, 11) %>%
   mutate(Time = dmy_hm(Time)) %>%
   mutate(Location = "Horsham") %>%
   select(Location, everything(), -`Wind Speed - average (km/h)`)
```

### Inspect Horsham data

```{r skim-Horsham}
skim(Horsham_w)
```

## Merge and filter the data for events

### Import the event data

Event data have dates and times when trap plants were deployed, retrieved and assessed for each event.

```{r import-event, message=FALSE}
events <- read_csv(here("data", "Dispersal experiments dates.csv")) %>% 
   mutate(`assessment date` = dmy(`assessment date`))

kable(events, format = "html", table.attr = 'class="table table-hover"')
```



### Filter the data

Filter the data removing any dates that do not have "event" data necessary for analysis.
To do this, first `filter()`, then use `case_when()` to match the dates and times with the `events` data frame and create new variables to indicate which replicate and location, which is used to determine an event in the data.

```{r filter}
Horsham_w <-
   Horsham_w %>%
   filter(
      Time >= events[[1, 3]] & Time <= events[[1, 4]] |
         Time >= events[[2, 3]] & Time <= events[[2, 4]] |
         Time >= events[[3, 3]] & Time <= events[[3, 4]] |
         Time >= events[[4, 3]] & Time <= events[[4, 4]] |
         Time >= events[[5, 3]] & Time <= events[[5, 4]]
   ) %>%
   mutate(
      Location = case_when(
         Time >= events[[1, 3]] & Time <= events[[1, 4]] ~ events[[1, 1]],
         Time >= events[[2, 3]] &
            Time <= events[[2, 4]] ~ events[[2, 1]],
         Time >= events[[3, 3]] &
            Time <= events[[3, 4]] ~ events[[3, 1]],
         Time >= events[[4, 3]] &
            Time <= events[[4, 4]] ~ events[[4, 1]],
         Time >= events[[5, 3]] &
            Time <= events[[5, 4]] ~ events[[5, 1]]
      )
   ) %>%
   mutate(
      Rep = case_when(
         Time >= events[[1, 3]] & Time <= events[[1, 4]] ~ events[[1, 2]],
         Time >= events[[2, 3]] &
            Time <= events[[2, 4]] ~ events[[2, 2]],
         Time >= events[[3, 3]] &
            Time <= events[[3, 4]] ~ events[[3, 2]],
         Time >= events[[4, 3]] &
            Time <= events[[4, 4]] ~ events[[4, 2]],
         Time >= events[[5, 3]] &
            Time <= events[[5, 4]] ~ events[[5, 2]]
      )
   ) %>%
   select(Location, Rep, Time, everything())

Curyo <-
   Curyo_w %>%
   filter(Time >= events[[6, 3]] & Time <= events[[6, 4]]) %>%
   mutate(Location2 = case_when(Time >= events[[6, 3]] &
                                   Time <= events[[6, 4]] ~ events[[6, 1]])) %>%
   mutate(Rep = case_when(Time >= events[[6, 3]] &
                             Time <= events[[6, 4]] ~ events[[6, 2]])) %>%
   select(Location, Rep, Time, everything())
```

### Merge the two location's weather data

```{r merge}
weather <- bind_rows(Curyo_w, Horsham_w)
```

### Rename columns and add other calculations

The `Wind Speed - average (km/h)` column is renamed to `mws` (mean wind speed) and the standard deviation of the wind speed and directions are calculated for the data.
The columns are then reordered by `Location`, `Rep`, `Time` and the weather data.

* mdr - mean direction degrees for wind

* mws - mean wind speed

* mdr_sd - standard deviation of the wind direction

* mws_sd - standard deviation of the wind speed

```{r rename-and-sd}
weather <- 
   weather %>% 
   mutate(`Wind Speed - average (km/h)` = `Wind Speed - average (km/h)`/3.6) %>% 
   rename(mws = `Wind Speed - average (km/h)`) %>% 
   rename(mdr = `Wind Direction - average (ยบ)`) %>%
   mutate(mws_sd = sd(mws)) %>% 
   mutate(direction_sd = sd(mdr)) %>% 
   select(Location, Rep, Time, everything())

glimpse(weather)
```
## Export weather to cache

Save the resulting weather data to the "cache" directory for further use.

```{r export-weather, message=FALSE}
write_csv(weather, here("cache", "cleaned_weather.csv"))
```
