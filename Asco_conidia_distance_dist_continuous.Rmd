---
title: "Spatial-temporal dispersal of _Ascochyta_ conidia"
author: "P. Melloy"
date: "`r Sys.Date()`"
output: html_document
---

# Aschochyta spore disperal

## Aims

Using the data collected from preliminary studies undertaken by Ihsan, we aim to produce a model when simulates the spread of conidia in a field within the season.  

To do this we are going to use the blackspot model provided by Art Diggle and change the dispersal parameters. We will need to revise each of the dispersal parameters to decide if they are suitable for ascochyta blight and change them according to the data we have.

Using the asco-conidia model we will simulate the spatial-temporal movement and compare it to new data obtained in future experiments. We will then use bayesian updating to improve the model before comparing the model with future trials.

```{r libraries_and_dataImport, output.lines = 20}
library(devtools)
library(readxl)
library(dplyr)
library(lme4)
library(knitr)
library(ggplot2)
library(mgcv)
source(file = "R/ggCaterpillar.R")

# update this when OneDrive decides to work
As_dat <-
  read.csv("data/CPSporesSpatial version 2.csv", stringsAsFactors = FALSE)

```

```{r format_data}
dbl <-
  c(
    "counts_p1",
    "counts_p2",
    "counts_p3",
    "counts_p4",
    "counts_p5",
    "mean_count_pot",
    "precip",
    "mrain",
    "mwd",
    "mws"
  )

# format lesion counts into double
As_dat[, dbl] <- lapply(As_dat[, dbl], as.double)

# change distance to continuous variable
As_dat$dist <- as.numeric(gsub(" m", "", As_dat$distance))

As_dat[, c("site", "distance", "rep")] <-
  lapply(As_dat[, c("site", "distance", "rep")], as.factor)

class(As_dat$dist)

```


From this data we hope to obtain the following.  
  - How far conidia can be dispersed in a spread event  
  - What combination of wind speed / direction / rain effects the dispersal distance.  
  
Due to the lack of reps at some of the distances we will ignore transect as a factor. We know wind direction will influence our results and we will need to accept that adds variation for which we may not be able to account for statistically.  

I will start using lmer to analyse the mean number of lesions per plant at each station. A station is defined by a pot containing five chickpea plants. The factor distance should be fit as a continuous variable, however because we don't know if the relationship between mean lesions and distance from the conidia dispersal foci is linear, we will start with distance as a categorical variable.  
Site is a categorical variable explaining the trial location. Each site may have experienced a different number of spread events, defined by the term 'rep'. Rainfall is required for conidia to disperse from the infested foci, and each rep constitutes either a simulated rainfall event, or a natural rainfall event. The following list describes the reps per site.  

```{r weatherReps}
weatherList <- list(pbc = 
        data.frame(
           rep = c(1,2,3),
           rainfall = round(c(10,10,max(As_dat$precip + As_dat$mrain, na.rm = TRUE)),4),
           WindDirection = round(unique(As_dat$mwd[As_dat$site == "pbc"])[c(1,3,4)],4),
           WindSpeed = round(unique(As_dat$mws[As_dat$site == "pbc"])[c(1,3,4)],4)
        ),
     'Horsham SPA' = 
        data.frame(
           rep = c(1,2,3),
           rainfall = round(unique(As_dat$precip[As_dat$site == "Horsham SPA"])[c(1,3,2)],4),
           WindDirection = round(unique(As_dat$mwd[As_dat$site == "Horsham SPA"])[c(1,3,2)],4),
           WindSpeed = round(unique(As_dat$mws[As_dat$site == "Horsham SPA"])[c(1,3,2)],4)
           ),
     Curyo = data.frame(
        rep = c(1,2,3),
        rainfall = round(unique(As_dat$precip[As_dat$site == "Curyo"])[c(1,2,2)],4),
        WindDirection = round(unique(As_dat$mwd[As_dat$site == "Curyo"])[c(1,2,2)],4),
        WindSpeed = round(unique(As_dat$mws[As_dat$site == "Curyo"])[c(1,2,2)],4)
     )
     
)

iterat <- 1
for(i in weatherList){
   print(kable(i, align = "c", caption = paste0("Weather during spread event at site ",names(weatherList)[iterat])))
   irerat <- iterat +1
}

```

The First models I will look at are asking:  
   (i) What is the estimated mean lesions per plant as each distance from the foci, given that the conditions of each spread event is nested within each site.  
   (ii) What is the estimated mean lesions per plant as each distance from the foci, given that the conditions of each spread event is nested within each site and the distance the spore travels is dependant on the spread event at each site.  

```{r lmer_mod}

mod1 <- lmer(mean_count_pot ~ dist + (1|site/rep),
             data = As_dat)

mod2 <- lmer(mean_count_pot ~ dist + (dist|site/rep),
             data = As_dat)

# Compare models
anova(mod1,mod2)
```
A comparison of the two models shows us that `mod2` is much better fit given the lower AIC.  

Lets examine the results of this analysis.  
```{r mod2_summary}
summary(mod2)
```

This analysis shows there is little residual variance compared to the the variation explained by our random effects. Also we can see that the amount of variation explained by site is lower than rep.  We should test that site is a significant random intercept term later. We can also not that as the distance increases so does the variance, this could be explained by the fact the spores are only going to travel further on a bearing that is the same as the wind direction.  

```{r Site_test}
# To test site we need to create a variable that describes a spread event regardless of location
As_dat$SpEv <- as.factor(paste0(As_dat$site,As_dat$rep))

mod2 <- lmer(mean_count_pot ~ dist + (dist|site/rep),
             data = As_dat)

mod3 <- lmer(mean_count_pot ~ dist + (dist|SpEv),
             data = As_dat)


# Compare models
anova(mod2,mod3)
```
Site is not a significant factor and we can use spread event variable instead. We will use `mod3` in the following analysis. This is shown by the lower AIC for mod3 and that the site/rep nesting is not significant on the chi squared test of models.  

The fixed effects give us the mean number of lesions per plant at distance zero (intercept) and this is significantly different from zero. We can also see the mean number of lesions decreases as distance from the foci increases.  

We can look at the best linear unbiased predictors of the random effects to see how much the 'rep' and 'site' influenced this spread.  

```{r mod2_coef}
coef(mod3)
```
Here the intercept is the estimated mean at zero meters from foci (BLUP). As the distance increases the number of estimated mean lesions per plant decreases.  
Lets look at the estimated means in a table.  


```{r}
summary(mod3)
```



```{r BLUP_table, eval=FALSE, include=FALSE}
BLUP_rep.site <- coef(mod2)$`rep:site`
BLUP_rep.site$rep <- data.frame(do.call(rbind, strsplit(row.names(BLUP_rep.site), split = ":")))[,1]
BLUP_rep.site$site <- data.frame(do.call(rbind, strsplit(row.names(BLUP_rep.site), split = ":")))[,2]
BLUP_rep.site[,2:5] <- BLUP_rep.site[,1] + BLUP_rep.site[,2:5]

rownames(BLUP_rep.site) <- NULL
BLUP_rep.site <- BLUP_rep.site[c(3,5,6,2,4,1),c("site","rep","(Intercept)","distance10 m","distance25 m","distance50 m","distance75 m")]
BLUP_rep.site[,c("rainfall","WindDirection", "WindSpeed")] <-
  bind_rows(weatherList)[!is.na(bind_rows(weatherList)$rainfall),
                       c("rainfall","WindDirection", "WindSpeed")]

kable(BLUP_rep.site)
```

```{r BLUP_plot_pba, eval=FALSE,}
# Reformat data to long form
p1_dat <- reshape2::melt(BLUP_rep.site[,1:7])

# rename column variables and values
names(p1_dat)[3:4] <- c("distance","lesions")

p1_dat[p1_dat$site == "pbc",] %>%
  ggplot(aes(x = distance, y = lesions, colour = rep))+
  geom_point()+
    geom_line(data = . %>%
              mutate(distance = as.numeric(distance)) %>%
              group_by(rep) %>%

              # Function taken from https://stackoverflow.com/questions/54898700/connecting-points-with-curved-line-on-ggplot-for-a-categorical-variable-on-the  
              # increase n for smoother line; can also try the other methods listed under
              # ?spline, though I find "natural" looks better than some of the rest: "fmm"'s 
              # curves are rather drastic, & "periodic" doesn't touch all the points
              summarise(x1 = list(spline(distance, lesions, n = 25, method = "natural")[["x"]]),
                        y1 = list(spline(distance, lesions, n = 25, method = "natural")[["y"]])) %>%

              tidyr::unnest(),
            aes(x = x1, y = y1))+
  labs(title="Estimated mean lesions (BLUPS) which developed as each distance",
       subtitle="Location: pbc", 
       col='Spread event (reps)')+
  geom_rect(aes(xmin = 3, xmax = 4.5, ymin = 3, ymax = 4.5, fill = NULL))+
  geom_segment(aes(x = 2.8, y = 3.2, xend = 2.8, yend = 4.2), 
               arrow = arrow(length = unit(0.03, "npc")))
```

```{r BLUP_plot_Horsham, eval=FALSE,}

p1_dat[p1_dat$site == "Horsham SPA",] %>%
  ggplot(aes(x = distance, y = lesions, colour = rep))+
  geom_point()+
    geom_line(data = . %>%
              mutate(distance = as.numeric(distance)) %>%
              group_by(rep) %>%

              # increase n for smoother line; can also try the other methods listed under
              # ?spline, though I find "natural" looks better than some of the rest: "fmm"'s 
              # curves are rather drastic, & "periodic" doesn't touch all the points
              summarise(x1 = list(spline(distance, lesions, n = 25, method = "natural")[["x"]]),
                        y1 = list(spline(distance, lesions, n = 25, method = "natural")[["y"]])) %>%

              tidyr::unnest(),
            aes(x = x1, y = y1))+
  labs(title="Estimated mean lesions (BLUPS) which developed as each distance",
       subtitle="Location: pbc", 
       col='Spread event (reps)')
  




p1_dat[p1_dat$site == "Curyo",] %>%
  ggplot(aes(x = distance, y = lesions, colour = rep))+
  geom_point()+
    geom_line(data = . %>%
              mutate(distance = as.numeric(distance)) %>%
              group_by(rep) %>%

              # increase n for smoother line; can also try the other methods listed under
              # ?spline, though I find "natural" looks better than some of the rest: "fmm"'s 
              # curves are rather drastic, & "periodic" doesn't touch all the points
              summarise(x1 = list(spline(distance, lesions, n = 25, method = "natural")[["x"]]),
                        y1 = list(spline(distance, lesions, n = 25, method = "natural")[["y"]])) %>%

              tidyr::unnest(),
            aes(x = x1, y = y1))+
  labs(title="Estimated mean lesions (BLUPS) which developed as each distance",
       subtitle="Location: pbc", 
       col='Spread event (reps)')

```



```{r GAM_analysis, eval=FALSE}

gam(mean_count_pot ~ s(dist, by = ),
    data = As_dat)

```




```{r, eval=FALSE,}
As_dat_pbc <- As_dat[As_dat$site == "pbc",]

mod10 <- lmer(mean_count_pot ~ distance + (1|mws:mwd),
             data = As_dat_pbc)

mod11 <- lmer(mean_count_pot ~ distance + (distance|mws:mwd),
             data = As_dat_pbc)

mod11 <- lmer(mean_count_pot ~ distance + (distance|mws:mwd),
             data = As_dat_pbc)

anova(mod10,mod11)

summary(mod11)
mod11_co <- coef(mod11)
cbind(mod11_co$`mws:mwd`[,1],
  coef(mod11)$`mws:mwd`[,1] + coef(mod11)$`mws:mwd`[,c('distance10 m', 'distance25 m', 'distance50 m','distance75 m')])

rowSums(cbind(coef(mod11)$`mws:mwd`[,1],
coef(mod11)$`mws:mwd`[,1] + coef(mod11)$`mws:mwd`[,c('distance10 m', 'distance25 m', 'distance50 m','distance75 m')]))



```





First I want to create a parameter for pot_rep at each specific location.

```{r eval=FALSE, include=FALSE}
pot_rep <- vector()
As_dat$pot_rep <- NA_real_

for(j in unique(As_dat$site)){
   dat1 <- As_dat[As_dat$site == j,]
   for(i in unique(dat1$dist_stat)[unique(dat1$dist_stat) != "NA"]){
   x1 <- seq_along(dat1[dat1$dist_stat == i,"dist_stat"])
   pot_rep <- c(pot_rep,x1)
}
As_dat[As_dat$site == j &
          As_dat$dist_stat !="NA",
       "pot_rep"] <- pot_rep
   }


As_dat[As_dat$dist_stat != "NA",]
length(x1)


```

